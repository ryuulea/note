'=== SJIS不可文字を検出する関数 ===
Private Function IsSjisSafeChar(c As String) As Boolean
    Dim b() As Byte
    On Error Resume Next
    b = StrConv(c, vbFromUnicode, 932) ' 932 = Shift-JIS
    If StrConv(b, vbUnicode, 932) = c Then
        IsSjisSafeChar = True
    Else
        IsSjisSafeChar = False
    End If
End Function


'=== メール本文 SJIS不可文字チェック ===
Public Sub CheckMailBody_SJIS()
    Const HEADER As String = "メール本文"
    Dim ws As Worksheet, outWs As Worksheet
    Dim hdrCell As Range, col As Long, startRow As Long, lastRow As Long
    Dim r As Long, txt As String, L As Long
    Dim i As Long, c As String, cp As Long
    Dim exportRowNo As Long
    Dim errCount As Long
    
    Set ws = ActiveSheet
    Set outWs = Worksheets("チェック結果")
    
    ' 出力開始行（E列の最後の下から）
    exportRowNo = outWs.Cells(outWs.Rows.Count, "E").End(xlUp).Row + 1
    
    ' 「メール本文」列を探す
    Set hdrCell = ws.Rows(1).Find(What:=HEADER, LookAt:=xlWhole)
    If hdrCell Is Nothing Then
        MsgBox "列見出し「" & HEADER & "」が見つかりません。", vbExclamation
        Exit Sub
    End If
    col = hdrCell.Column
    
    ' データ範囲
    startRow = 2
    lastRow = ws.Cells(ws.Rows.Count, col).End(xlUp).Row
    
    ' 本文チェック（逐字）
    For r = startRow To lastRow
        txt = CStr(ws.Cells(r, col).Value)
        L = Len(txt)
        
        For i = 1 To L
            c = Mid(txt, i, 1)
            cp = AscW(c)
            
            If Not IsSjisSafeChar(c) Then
                outWs.Range("E" & exportRowNo).Value = c
                outWs.Range("F" & exportRowNo).Value = _
                    "表行:" & r & " / 本文内位置:" & i & " / 文字コード: U+" & Hex(cp)
                exportRowNo = exportRowNo + 1
                errCount = errCount + 1
            End If
        Next i
    Next r
    
    ' 結果メッセージ
    If errCount = 0 Then
        MsgBox "本文中にSJIS不可文字は見つかりませんでした。", vbInformation
    Else
        MsgBox "本文中にSJIS不可文字が " & errCount & " 件見つかりました。" & vbCrLf & _
               "詳細はチェック結果シートをご確認ください。", vbExclamation
    End If
End Sub
